<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet author="CONNECT_APP" id="ITER_131_ALTER_VIEW_FOR_USER_EXPORTED_V_USER_EXPORT_NO_FINAL_USERS">
        <sql>
        <!-- Replace &lt;&gt;  by <> -->
			ALTER VIEW [dbo].[V_USER_EXPORT]
				AS
				SELECT DISTINCT ROW_NUMBER() OVER (ORDER BY U.ID) AS ID,
				U.ID AS USER_ID,
				O.ORG_CODE AS ORG_CODE,
		        EO.EXTERNAL_CUSTOMER_NAME AS EXTERNAL_CUSTOMER_NAME,
		        EU.USERNAME AS EXTERNAL_USER_NAME,
				U.USERNAME AS USER_NAME,
				U.FIRST_NAME AS FIRST_NAME,
				U.LAST_NAME AS LAST_NAME,
				U.EMAIL AS USER_EMAIL,
				A.ZIPCODE AS ZIPCODE,
				OP.SHORTNAME AS ORG_PARENT_SHORT_NAME,
				LG.FIRST_LOGIN_DATE AS FIRST_LOGIN_DATE,
				U.SIGN_IN_DATE AS LAST_LOGIN_DATE,
				R.NAME AS ROLE_NAME,
				SL.CODE AS SALUTATION,
				L.LANGISO AS LANGISO,
				LG.IS_USER_ACTIVE
				from
				dbo.ESHOP_USER U
				JOIN dbo.GROUP_USER GU ON U.ID = GU.USER_ID
				JOIN dbo.ESHOP_GROUP G ON GU.GROUP_ID = G.ID
				JOIN dbo.GROUP_ROLE GR ON GR.GROUP_ID = G.ID
				JOIN dbo.ESHOP_ROLE R ON GR.ROLE_ID = R.ID
				JOIN dbo.ORGANISATION_GROUP OG ON G.ID = OG.GROUP_ID
				JOIN dbo.ORGANISATION O ON O.ID = OG.ORGANISATION_ID
				JOIN dbo.ORGANISATION OP ON O.PARENT_ID=OP.ID
				JOIN dbo.LOGIN LG ON LG.USER_ID = U.ID
				JOIN dbo.SALUTATION SL ON SL.ID = U.SALUTATION
				JOIN dbo.LANGUAGES L ON U.LANGUAGE = L.ID
				LEFT JOIN dbo.EXTERNAL_ORGANISATION EO ON EO.ORG_ID=O.ID
				LEFT JOIN dbo.EXTERNAL_USER EU ON EU.ESHOP_USER_ID = U.ID
				LEFT JOIN dbo.ORGANISATION_ADDRESS OA ON OA.ORGANISATION_ID = O.ID
		        LEFT JOIN dbo.ADDRESS A ON A.ID=OA.ADDRESS_ID
				WHERE (U.TYPE IS NULL OR (U.TYPE &lt;&gt; 'ON_BEHALF_ADMIN' AND  U.TYPE &lt;&gt; 'VIRTUAL_DMS' AND U.TYPE &lt;&gt; 'VIRTUAL_OCI'))
				AND (O.ORG_CODE IS NOT NULL) AND (O.ORG_CODE &lt;&gt; '')
       </sql>
    </changeSet>

	<changeSet author="CONNECT_APP" id="ITER_131_DROP_COLUMS_ID_SAG_VEHICLE">
		<sql>
			-- IT SHOULD BE EXECUTED BY MANUALLY
			ALTER TABLE dbo.VEHICLE_HISTORY DROP COLUMN ID_SAG;
			ALTER TABLE dbo.VEHICLE_HISTORY DROP COLUMN ID_SAG_MAKE;
			ALTER TABLE dbo.VEHICLE_HISTORY DROP COLUMN ID_SAG_MODEL;
		</sql>
	</changeSet>
</databaseChangeLog>
