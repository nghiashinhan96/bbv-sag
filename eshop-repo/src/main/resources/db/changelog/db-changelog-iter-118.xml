<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

  <changeSet author="CONNECT_APP" id="ITER_118_ALTER_VIEW_V_FINAL_CUSTOMER_ORDER_ADD_REFERENCE">
    <sql>
	-- #5078 WSS - Display Final Customer Reference on the Wholesaler's list of New,Open or ordered orders
	ALTER VIEW [dbo].[V_FINAL_CUSTOMER_ORDER] AS
	SELECT DISTINCT
	  FO.DATE,
	  FO.ID AS ID,
	  O.NAME AS COMPANY_NAME,
	  (SELECT VALUE FROM FINAL_CUSTOMER_PROPERTY WHERE ORG_ID = FO.ORG_ID and SETTING_KEY='ADDRESS_1') AS ADDRESS,
	  (SELECT VALUE FROM FINAL_CUSTOMER_PROPERTY WHERE ORG_ID = FO.ORG_ID and SETTING_KEY='POSTCODE') AS POSTCODE,
	  (SELECT VALUE FROM FINAL_CUSTOMER_PROPERTY WHERE ORG_ID = FO.ORG_ID and SETTING_KEY='CUSTOMER_NUMBER') AS CUSTOMER_NUMBER,
	  (SELECT
		STUFF((SELECT ';' + t2.VEHICLE_DESC
			FROM FINAL_CUSTOMER_ORDER_ITEM t2
			WHERE t1.ID = t2.FINAL_CUSTOMER_ORDER_ID
			AND t2.VEHICLE_DESC IS NOT NULL AND t2.VEHICLE_DESC &lt;&gt; ''
			FOR XML PATH('')), 1, 1, '')
		FROM FINAL_CUSTOMER_ORDER t1
		WHERE ID = FO.ID
		GROUP BY ID) AS VEHICLE_DESCS,
	  (SELECT TOP(1) ARTICLE_DESC FROM FINAL_CUSTOMER_ORDER_ITEM WHERE FINAL_CUSTOMER_ORDER_ID = FO.ID) AS ARTICLE_DESC,
	  (SELECT USERNAME FROM ESHOP_USER WHERE ID = FO.USER_ID) AS USERNAME,
	  FO.STATUS,
	  FO.ORG_ID,
	  FO.TOTAL_GROSS_PRICE,
	  FO.REFERENCE,
	  FO.BRANCH_REMARK,
	  (SELECT
		STUFF((SELECT ';' + t2.ARTICLE_DESC + ' ' + t2.REFERENCE 
			FROM FINAL_CUSTOMER_ORDER_ITEM t2
			WHERE t1.ID = t2.FINAL_CUSTOMER_ORDER_ID
			AND t2.REFERENCE IS NOT NULL AND t2.REFERENCE &lt;&gt; ''
			FOR XML PATH('')), 1, 1, '')
		FROM FINAL_CUSTOMER_ORDER t1
		WHERE ID = FO.ID
		GROUP BY ID) AS POSITION_REFERENCES
	FROM
	  FINAL_CUSTOMER_ORDER FO
	  LEFT JOIN FINAL_CUSTOMER_PROPERTY FP
	  ON FP.ORG_ID = FO.ORG_ID
	  AND (FP.SETTING_KEY = 'ADDRESS_1' OR FP.SETTING_KEY = 'POSTCODE' OR FP.SETTING_KEY = 'CUSTOMER_NUMBER')
	  LEFT JOIN ORGANISATION O ON O.ID=FO.ORG_ID
	  WHERE FO.STATUS &lt;&gt; 'DELETED'
    </sql>
  </changeSet>

  <changeSet author="CONNECT_APP" id="ITER_118_ALTER_TABLE_FINAL_CUSTOMER_ORDER_ITEM_ADD_PRIMARY_KEY">
    <sql>
	  ALTER TABLE FINAL_CUSTOMER_ORDER_ITEM ADD CONSTRAINT PK_FINAL_CUSTOMER_ORDER_ITEM_ID PRIMARY KEY CLUSTERED (ID);
    </sql>
  </changeSet>

  <changeSet author="CONNECT_APP" id="ITER_118_ALTER_TABLE_FINAL_CUSTOMER_ORDER_ITEM_ADD_INDEX">
    <sql>
	  CREATE INDEX IDX_FINAL_CUSTOMER_ORDER_USER_ID ON [dbo].FINAL_CUSTOMER_ORDER (USER_ID);
	  CREATE INDEX IDX_FINAL_CUSTOMER_ORDER_ORG_ID ON [dbo].FINAL_CUSTOMER_ORDER (ORG_ID);
	  CREATE INDEX IDX_FINAL_CUSTOMER_ORDER_ITEM_FINAL_CUSTOMER_ORDER_ID ON [dbo].FINAL_CUSTOMER_ORDER_ITEM (FINAL_CUSTOMER_ORDER_ID);
    </sql>
  </changeSet>

  <changeSet author="CONNECT_APP" id="ITER_118_ALTER_TABLE_ORDER_HISTORY_ADD_COLUMNS_VEHICLE_INFOS">
    <sql>
      ALTER TABLE ORDER_HISTORY ADD VEHICLE_INFOS varchar(256) null;
    </sql>
  </changeSet>

  <changeSet author="CONNECT_APP" id="ITER_118_ALTER_TABLE_ORDER_HISTORY_ALTER_COLUMNS_SIZE_ERP_ORDER_DETAIL_URL">
    <sql>
      ALTER TABLE ORDER_HISTORY ALTER COLUMN ERP_ORDER_DETAIL_URL varchar(2048) null;
    </sql>
  </changeSet>

  <changeSet author="CONNECT_APP" id="ITER_118_CREATE_VIEW_V_CUSTOMER_ORDER_HISTORY">
    <sql>
		CREATE VIEW [dbo].[V_CUSTOMER_ORDER_HISTORY] AS
		  SELECT
		    o.ID,
		    o.ORDER_NUMBER,
		    o.TRANS_NUMBER,
		    o.CREATED_DATE,
			o.VEHICLE_INFOS,
		    o.ERP_ORDER_DETAIL_URL,
		    o.USER_ID,
		    u.USERNAME,
		    o.CUSTOMER_NUMBER,
		    o.ORDER_STATE,
		    o.FINAL_CUSTOMER_ORDER_ID,
		    o.GOODS_RECEIVER_ID
		  FROM ORDER_HISTORY o 
		  JOIN ESHOP_USER u ON u.id = o.USER_ID
		  WHERE o.ORDER_NUMBER IS NOT NULL
    </sql>
  </changeSet>
  <changeSet author="CONNECT_APP" id="ITER_118_INSERT_DELIVERY_ADDRESS_TYPE">
    <sql>
      INSERT INTO [dbo].[ADDRESS_TYPE] (TYPE, DESCRIPTION) VALUES ('DELIVERY', 'Delivery');
    </sql>
  </changeSet>

  <changeSet author="CONNECT_APP" id="ITER_118_ADD_COLUMN_CUSTOMER_SETTINGS_HAS_PARTNER_PROGRAM_VIEW">
	<sql>
      IF NOT EXISTS (
		SELECT 1 FROM
		INFORMATION_SCHEMA.COLUMNS
	  WHERE
		TABLE_NAME = 'CUSTOMER_SETTINGS'
		AND COLUMN_NAME = 'HAS_PARTNER_PROGRAM_VIEW')
	  BEGIN
		ALTER TABLE [dbo].[CUSTOMER_SETTINGS] ADD [HAS_PARTNER_PROGRAM_VIEW] bit NOT NULL DEFAULT 0
	  END;
	</sql>
  </changeSet>

</databaseChangeLog>
