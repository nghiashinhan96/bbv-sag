SAG-TOOL-AX
================

The tool is built for executing batch job such as migration, transfering, converting data from other systems into Connect system.

## Installation
```maven
mvn clean install
```

## Execution
```sh
java -jar <jar-file> --spring.profiles.active=<profile-parameter> --spring.profiles.include=<profile-included-parameters> --spring.batch.job.names=<batch-job-name> <support-parameters>
```

Explaination

| No | Profile Name | Description | Note |
| -- | ------------ | ----------- | ---- |
| 01 | jar-file | ----------- | ---- |
| 02 | profile-parameter | ----------- | ---- |
| 03 | profile-included-parameters | ----------- | ---- |
| 04 | batch-job-name | ----------- | ---- |
| 05 | support-parameters | ----------- | ---- |

Example

```sh
java -jar sag-tools-1.0-SNAPSHOT.jar --spring.profiles.active=ch-dev --spring.batch.job.names=ImportSsoSalesUsers
```

### List of Profiles

| No | Profile Name | Description | Note |
| -- | ------------ | ----------- | ---- |
| 01 | at-dev |  |  |
| 02 | at-umbpre |  |  |
| 03 | at-umbprod |  |  |
| 04 | ch-dev |  |  |
| 05 | ch-umbpre |  |  |
| 06 | ch-umbprod |  |  |
| 07 | local |  |  |
| 08 | source-ax-pre |  |  |
| 09 | source-ax-prod |  |  |
| 10 | source-ebl |  |  |
| 11 | source-no-ebl |  |  |
| 12 | srouce-es-dev |  |  |
| 13 | source-es-umbpre |  |  |
| 14 | source-es-umbprod |  |  |
| 15 | source-mdm |  |  |
| 16 | source-no-sagsys |  |  |
| 17 | source-sagsys-umbpre |  |  |
| 18 | target-at-umbpre |  |  |
| 19 | target-at-umbprod |  |  |
| 20 | target-ch-umbpre |  |  |
| 21 | target-ch-umbprod |  |  |



## Batch

| No | Batch Job Name | Desciption | Parameters | Example | Note |
| -- | -------------- | ---------- | ---------- | ------- | ---- |
| 01 | tourTimeMigration | ---------- | ---------- | ------- | ---- |
| 02 | -------------- | ---------- | ---------- | ------- | ---- |
| 03 | -------------- | ---------- | ---------- | ------- | ---- |
| 04 | -------------- | ---------- | ---------- | ------- | ---- |
| 05 | -------------- | ---------- | ---------- | ------- | ---- |
| 06 | -------------- | ---------- | ---------- | ------- | ---- |
| 07 | -------------- | ---------- | ---------- | ------- | ---- |
| 08 | -------------- | ---------- | ---------- | ------- | ---- |
| 09 | -------------- | ---------- | ---------- | ------- | ---- |
| 10 | -------------- | ---------- | ---------- | ------- | ---- |
| 11 | -------------- | ---------- | ---------- | ------- | ---- |
| 12 | -------------- | ---------- | ---------- | ------- | ---- |


### Batch Job Guide

After implementation, we need execute our batch jobs to complete the work.

As you know, we just have the one spare instance to execute all batch-jobs for SAG infrastructures,

so we should arrange and organize batch jobs to ensure we execute correct job and complete work successfully.

Batch Job Execution Instance: [Wiki-Env] #TESTING

How to execute them:

* After implementation, we will packaging the jar file

* Upload to execution instance

* Executing them by command line

* Monitoring if need

* Verify the result if need


#### 1. Load Tour time table

The job serve for loading new updated tour time file into the TOUR_TIME table schema,

we recommend will load for **Pre-Production first** and **next to Production**

Because at Production we serve for end-users, so we cannot import TOUR_TIME table directly, 

it will interrupt the availability calculation, return wrong result to end-users,

So we will load them into the **swapping TOUR_TIME table** for preparation, after completed UMB will swap them.

**1. Explaination**

PO will provide the excel file contains all tour time data.

Popular file name: *Routes for customers with invent locations.xlxs*

It will have excel table format

| CUSTOMER | INVENTLOCATIONID | ROUTECONFIGNAME | ROUTESCHEDULENAME | ROUTESCHEDULEAISINFORMATION |
| -- | -------------- | ---------- | ---------- | ------- |
| 1000 | 2000 | 2000_40_1900 | Carrosserie-Transport | 2000_40_1900 |


*Definition*:

1. CUSTOMER: the customer number
2. INVENTLOCATIONID: the branch id
3. ROUTECONFIGNAME: the tour overall name
4. ROUTESCHEDULENAME: the tour description
5. ROUTESCHEDULEAISINFORMATION: the detail tour code(name)

***TOUR_TIME*** table schema in DB

| ID | CUSTOMER_NUMBER | BRANCH_ID | TOUR_NAME |
| -- | -------------- | ---------- | ---------- |
| 1 | 1000 | 2000 | 2000_40_1900 |

We are mapping with excel table as below:

| DB's COLUMN | <=> | EXCEL's COLUMN | 
| -- | -------------- | ---------- |
| ID | --- | No need, it will be generated by DB server |
| CUSTOMER_NUMBER | <=> | CUSTOMER |
| BRANCH_ID | <=> | INVENTLOCATIONID |
| TOUR_NAME | <=> | ROUTESCHEDULEAISINFORMATION |

Because we don't have the excel reader in batch job, so we will have some additional process by manually to export them to CSV file.

1. Open file by Microsoft Excel
2. Remove unneed column in file
3. Save them as csv format.
4. Verify the new csv file
5. Split csv file if big file.
6. We should prepare all command lines in one bash script to execute once time in the instance.
7. Monitoring the batch job and verify result
8. Additional work: in some split csv tool will contain the header column, and we need verify and remove them into db after complete the loading job
9. 

**2. How to process**

After prepare all things, we will execute the batch job with below steps:

First thing we need clean old data in the existing table, I mean we need truncate table with SQL query in DB directly.

```sql
TRUNCATE table dbo.<TOUR_TIME table> ;
);
```
```sql
drop table TOUR_TIME_SWAP
CREATE TABLE [TOUR_TIME_SWAP] (
    ID int IDENTITY(1,1) PRIMARY KEY,
    CUSTOMER_NUMBER [varchar](20) NOT NULL,
    BRANCH_ID [varchar](20) NULL,
    TOUR_NAME [varchar](255) NULL,
);
```

At Development, Pre-Production: **TOUR_TIME** table

At Production:
  We need to clean old data in the given target table (ex: **TOUR_TIME_BAK**), or we create a new table (ex: **TOUR_TIME_1108**) and inform PO (please confirm with PO before executing the sql). Then we need to update the code (mapping TargetTourTime to the confirmed table) and build sag-tool-v2 module to pack the jar file again.

Next step, we will access the execution server and trigger bash script and waiting

**Execution script**

For CH

```sh
java -jar sag-tools-1.0-CHProd.jar --spring.profiles.active=ch-umbprod --spring.profiles.include=source-no-ebl,source-no-sagsys,source-mdm,source-ax-pre,source-es-umbpre,target-ch-umbprod --spring.batch.job.names=tourTimeMigration --csv.tour_time=TOUR_TIME_CH_1.csv
```

For AT

```sh
java -jar sag-tools-1.0-ATProd.jar --spring.profiles.active=at-umbprod --spring.profiles.include=source-no-ebl,source-no-sagsys,source-mdm,source-ax-pre,source-es-umbpre,target-at-umbprod --spring.batch.job.names=tourTimeMigration --csv.tour_time=TOUR_TIME-1.csv

```


#### 2. Offer Migration

coming soon...


## Technology

### Backend
- Java 8, JDK 1.8 (planning to upgrade to later Java version (TBD.) in 2020)
- Spring Boot (v2.0.1.RELEASE)
-  Spring Batch
- Hibernate
	- Connection Pool: Hikari CP
- ElasticSearch
- Hazelcast
- Lombok
- Logback, SLF4J

## Environment

Refer to this page <a href="https://tfs.bbv.ch/tfs/SAGCollection/Connect%20Plus/_wiki/wikis/Connect-Plus.wiki?wikiVersion=GBwikiMaster&pagePath=%2FConnect%20Plus%20Home%20Page%2FDeployment%20Guide%2FSAG%20eShop%20Environment%20Version%202&pageId=44"> Environment Page</a>

## License

[SAG]

[//]: #

[SAG]: https://www.sag-ag.ch/
[Eclipse]: https://www.eclipse.org/downloads/
[IntelliJ]: https://www.jetbrains.com/idea/download/#section=windows
[dbeaver]: https://dbeaver.io/download/
[Wiki-Env]: https://tfs.bbv.ch/tfs/SAGCollection/Connect%20Plus/_wiki/wikis/Connect-Plus.wiki?wikiVersion=GBwikiMaster&pagePath=%2FConnect%20Plus%20Home%20Page%2FDeployment%20Guide%2FSAG%20eShop%20Environment%20Version%202&pageId=44
